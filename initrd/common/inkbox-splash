#!/bin/sh
# Displays a big "InkBox" splash from the initrd userspace

DEVICE=$(cat /opt/device)

setup() {
	mkdir -p /splash
	cd /splash
	tar -xf /opt/splash-rootfs.tar.xz
	cd - &>/dev/null

	cp /bin/busybox /splash/bin/busybox
	mount -t devtmpfs devtmpfs /splash/dev
	mount -t sysfs sysfs /splash/sys
	mount -t proc proc /splash/proc
}

cleanup() {
	umount /splash/dev -l -f
	umount /splash/sys -l -f
	umount /splash/proc -l -f
	rm -rf /splash
}

if [ "${DEVICE}" == "n705" ] || [ "${DEVICE}" == "n905b" ] || [ "${DEVICE}" == "n905c" ]; then
        ROW=30
	ALERT_ROW=18
elif [ "${DEVICE}" == "n613" ]; then
        ROW=37
	ALERT_ROW=24
elif [ "${DEVICE}" == "n873" ]; then
        ROW=30
	ALERT_ROW=18
else
	ROW=30
	ALERT_ROW=18
fi

if [ "${DEVICE}" == "n905b" ] || [ "${DEVICE}" == "n905c" ] || [ "${DEVICE}" == "n613" ]; then
	SIZE=70
elif [ "${DEVICE}" == "n705" ]; then
	SIZE=55
elif [ "${DEVICE}" == "n873" ]; then
	SIZE=90
else
	SIZE=70
fi

if [ "${DEVICE}" == "n705" ] || [ "${DEVICE}" == "n905b" ] || [ "${DEVICE}" == "n905c" ] || [ "${DEVICE}" == "n613" ]; then
	FB_UR=3
elif [ "${DEVICE}" == "n873" ]; then
	FB_UR=0
else
	FB_UR=3
fi

if [ ! -z ${UPDATE_SPLASH_PID} ]; then
	kill -9 ${UPDATE_SPLASH_PID}
	cleanup
	setup
else
	setup
fi

echo ${FB_UR} > /sys/class/graphics/fb0/rotate

if [ "${1}" == "update_splash" ]; then
	ln -s /bin/busybox /splash/bin/sh
	ln -s /bin/busybox /splash/bin/sleep
	LD_LIBRARY_PATH=/opt/fbink busybox chroot /splash /opt/fbink/fbink "-k" "-f" "-h" "-q"
	LD_LIBRARY_PATH=/opt/fbink busybox chroot /splash /opt/fbink/fbink "-t" "regular=/opt/fbink/inter-b.ttf,size=20" "Updating" "-m" "-M" "-h" "-q"
	LD_LIBRARY_PATH=/opt/fbink busybox chroot /splash /opt/bin/update-splash "${ROW}" &
elif [ "${1}" == "alert_splash" ]; then
	ln -s /bin/busybox /splash/bin/sh
	ln -s /bin/busybox /splash/bin/cat
	/opt/bin/alert-ascii.sh /splash/alert.ascii "${2}"
	LD_LIBRARY_PATH=/opt/fbink busybox chroot /splash /opt/fbink/fbink "-k" "-f" "-q"
	LD_LIBRARY_PATH=/opt/fbink busybox chroot /splash /bin/sh "-c" "cat /alert.ascii | /opt/fbink/fbink -q -m -y ${ALERT_ROW}"
elif [ "${1}" == "developer_splash" ]; then
	while true; do
		LD_LIBRARY_PATH=/opt/fbink busybox chroot /splash /opt/fbink/fbink "-m" "█ █ █ █ Developer mode █ █ █ █" "-y" "2" "-q"
		sleep 30
	done
else
	LD_LIBRARY_PATH=/opt/fbink busybox chroot /splash /opt/fbink/fbink "-k" "-f" "-q"
	LD_LIBRARY_PATH=/opt/fbink busybox chroot /splash /opt/fbink/fbink "-M" "-m" "-q" "-t" "regular=/opt/fbink/fraunces.ttf,size=${SIZE}" "InkBox"
fi

if [ "${1}" != "update_splash" ]; then
	cleanup
fi
