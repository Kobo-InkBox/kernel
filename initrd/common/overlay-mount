#!/bin/sh

DEVICE=$(cat /opt/device)
if [ "${DEVICE}" == "n705" ] || [ "${DEVICE}" == "n905b" ] || [ "${DEVICE}" == "n905c" ] || [ "${DEVICE}" == "n613" ]; then
	ROOTFS_FMT="ext4"
	RECOVERYFS_PART=2
elif [ "${DEVICE}" == "n873" ]; then
	ROOTFS_FMT="vfat"
	RECOVERYFS_PART=5
else
	ROOTFS_FMT="ext4"
	RECOVERYFS_PART=2
fi

if [ "${DEVICE}" == "n905b" ]; then
	GENUINE_RECOVERYFS_CHECKSUM="7f771fde42624452185b9e46b2990382d8c649ea5d1be5788caa2b3f1676ebe7"
elif [ "${DEVICE}" == "n873" ]; then
	GENUINE_RECOVERYFS_CHECKSUM="0000000000000000000000000000000000000000000000000000000000000000"
fi

if [ "${1}" != "recovery" ]; then
	## Mounting root filesystem with squashfuse and fuse-overlayfs (read-only by default)
	mkdir -p /rootfs-part
	mkdir -p /overlaymount-rootfs
	mount -t "${ROOTFS_FMT}" -o nosuid /dev/mmcblk0p3 /rootfs-part
	/usr/bin/unsquashfs -f -d /key /opt/key.sqsh &>/dev/null
	echo "Verifying root filesystem's digital signature ..."
	/usr/bin/openssl dgst -sha256 -verify /key/public.pem -signature /rootfs-part/rootfs.squashfs.dgst /rootfs-part/rootfs.squashfs &>/dev/null
	if [ ${?} != 0 ]; then
		echo "Root filesystem's digital signature is invalid! Shutting down ..."
		sync
		umount /rootfs-part -l -f
		/etc/init.d/inkbox-splash alert_splash 3
		busybox poweroff
		exit 1
	else
		echo "Done."
		# Some mountpoints
		mkdir -p /rootfs-part/rootfs/read
		mkdir -p /rootfs-part/rootfs/work
		mkdir -p /rootfs-part/rootfs/write
		mkdir -p /rootfs-part/rootfs/overlay

		/usr/bin/openssl dgst -sha256 -verify /key/public.pem -signature /rootfs-part/overlaymount-rootfs.squashfs.dgst /rootfs-part/overlaymount-rootfs.squashfs &>/dev/null
		if [ ${?} != 0 ]; then
			echo "Utility root filesystem's signature is invalid! Shutting down ..."
			sync
			umount /rootfs-part -l -f
			/etc/init.d/inkbox-splash alert_splash 5
			busybox poweroff
			exit 1
		else
			losetup /dev/loop1 /rootfs-part/overlaymount-rootfs.squashfs
			mount /dev/loop1 /overlaymount-rootfs
		fi

		# Filesystems
		mount -t devtmpfs devtmpfs /overlaymount-rootfs/dev
		mount -t sysfs sysfs /overlaymount-rootfs/sys
		mount -t tmpfs tmpfs /overlaymount-rootfs/mnt
		mount -t proc proc /overlaymount-rootfs/proc
		mkdir -p /overlaymount-rootfs/mnt/rootfs-part
		mkdir -p /overlaymount-rootfs/mnt/rootfs
		mount --bind /rootfs-part /overlaymount-rootfs/mnt/rootfs-part
		mount --bind /rootfs-part/rootfs /overlaymount-rootfs/mnt/rootfs
		rm -r /mnt
		ln -s /overlaymount-rootfs/mnt/rootfs/overlay /mnt

		busybox chroot /overlaymount-rootfs "/bin/squashfuse" "/mnt/rootfs-part/rootfs.squashfs" "/mnt/rootfs/read"
		if [ "${1}" == "ro" ]; then
			if [ "${2}" == "std" ]; then
				busybox chroot /overlaymount-rootfs "/bin/fuse-overlayfs" "-o" "ro,nosuid,lowerdir=/mnt/rootfs/read,upperdir=/mnt/rootfs/write,workdir=/mnt/rootfs/work" "/mnt/rootfs/overlay"
			else
				busybox chroot /overlaymount-rootfs "/bin/fuse-overlayfs" "-o" "ro,lowerdir=/mnt/rootfs/read,upperdir=/mnt/rootfs/write,workdir=/mnt/rootfs/work" "/mnt/rootfs/overlay"
			fi
		elif [ "${1}" == "rw" ]; then
			busybox chroot /overlaymount-rootfs "/bin/fuse-overlayfs" "-o" "lowerdir=/mnt/rootfs/read,upperdir=/mnt/rootfs/write,workdir=/mnt/rootfs/work" "/mnt/rootfs/overlay"
		else
			echo "Invalid argument"
			exit 1
		fi
	fi
else
	## Mounting recovery filesystem
	mkdir -p /recoveryfs-part
	mkdir -p /overlaymount-rootfs
	mount -t ext4 -o nosuid,ro "/dev/mmcblk0p${RECOVERYFS_PART}" "/recoveryfs-part"

	if [ -z "${EXPRESS_VERIFICATION}" ]; then
		# Safe
		/usr/bin/unsquashfs -f -d /key /opt/key.sqsh &>/dev/null
		/usr/bin/openssl dgst -sha256 -verify /key/public.pem -signature /recoveryfs-part/overlaymount-rootfs.squashfs.dgst /recoveryfs-part/overlaymount-rootfs.squashfs &>/dev/null
		if [ ${?} != 0 ]; then
			echo "Utility root filesystem's signature is invalid! Shutting down ..."
			sync
			umount -l -f /recoveryfs-part
			/etc/init.d/inkbox-splash alert_splash 5
			busybox poweroff
			exit 1
		else
			losetup /dev/loop1 /recoveryfs-part/overlaymount-rootfs.squashfs
			mount /dev/loop1 /overlaymount-rootfs
		fi
	else
		# Dangerous
		LOCAL_RECOVERYFS_CHECKSUM=$(dd if=/recoveryfs-part/recoveryfs.squashfs bs=1M count=1 status=none | sha256sum | awk '{ print $1 }')
		if [ "${LOCAL_RECOVERYFS_CHECKSUM}" != "${GENUINE_RECOVERYFS_CHECKSUM}" ]; then
			echo "EXPRESS_VERIFICATION: checksum invalid!"
			exit 1
		else
			losetup /dev/loop1 /recoveryfs-part/overlaymount-rootfs.squashfs
			mount /dev/loop1 /overlaymount-rootfs
		fi
	fi

	# Filesystems
	mount -t devtmpfs devtmpfs /overlaymount-rootfs/dev
	mount -t sysfs sysfs /overlaymount-rootfs/sys
	mount -t tmpfs tmpfs /overlaymount-rootfs/mnt
	mount -t proc proc /overlaymount-rootfs/proc
	mkdir -p /overlaymount-rootfs/mnt/recoveryfs-part
	mkdir -p /overlaymount-rootfs/mnt/recoveryfs
	mount --bind /recoveryfs-part /overlaymount-rootfs/mnt/recoveryfs-part
	rm -r /mnt
	ln -s /overlaymount-rootfs/mnt/recoveryfs /mnt

	echo "Verifying recovery filesystem's digital signature ..."
	/usr/bin/openssl dgst -sha256 -verify /key/public.pem -signature /recoveryfs-part/recoveryfs.squashfs.dgst /recoveryfs-part/recoveryfs.squashfs &>/dev/null
	if [ ${?} != 0 ]; then
		echo "Recovery filesystem's digital signature is invalid! Shutting down ..."
		sync
		umount /recoveryfs-part -l -f
		/etc/init.d/inkbox-splash alert_splash 4
		busybox poweroff
		exit 1
	else
		echo "Done."
		busybox chroot /overlaymount-rootfs "/bin/squashfuse" "/mnt/recoveryfs-part/recoveryfs.squashfs" "/mnt/recoveryfs"
	fi

	cp /opt/device /tmp/device
	mount --bind /tmp/device /overlaymount-rootfs/mnt/recoveryfs/opt/device
fi

